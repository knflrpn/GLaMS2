<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwiCC Controller Display</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #ffffff;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #2d2d2d;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #444;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #444;
        }

        .status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4444;
            transition: background 0.3s ease;
        }

        .status-dot.connected {
            background: #44ff44;
        }

        .info-line {
            margin: 5px 0;
            color: #aaa;
        }

        .snapshots-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .snapshot-section {
            padding: 15px;
            background: #1a1a1a;
            border-radius: 8px;
            border-left: 4px solid #4fd1c7;
        }

        .snapshot-section.inner {
            border-left-color: #ff6b6b;
        }

        .snapshot-section.outer {
            border-left-color: #4ecdc4;
        }

        .snapshot-section h3 {
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .snapshot-section.inner h3 {
            color: #ff6b6b;
        }

        .snapshot-section.outer h3 {
            color: #4ecdc4;
        }

        .snapshot-meta {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 10px;
        }

        .data-content {
            white-space: pre-wrap;
            font-size: 0.9rem;
            line-height: 1.4;
            color: #ccc;
            max-height: 400px;
            overflow-y: auto;
        }

        .no-data {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
            grid-column: 1 / -1;
        }

        .no-snapshot {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .snapshots-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸŽ® SwiCC Controller Display</h1>
            <div class="status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Waiting for connection...</span>
            </div>
            <div class="info-line">Channel: <span id="channelName">swicc-controller</span></div>
            <div class="info-line">Rate: <span id="messageRate">0</span> msg/s | Updates: <span id="updateCount">0</span></div>
            <div class="info-line">Last Update: <span id="lastUpdate">Never</span></div>
        </div>

        <div id="dataDisplay">
            <div class="no-data">No controller data received yet</div>
        </div>
    </div>

    <script>
        class ControllerDisplay {
            constructor(channelName = 'swicc-controller') {
                this.channelName = channelName;
                this.channel = null;
                this.connected = false;
                this.messageCount = 0;
                this.updateCount = 0;
                this.lastMessageTime = 0;
                this.messageRate = 0;
                this.lastUpdate = null;
                
                // Current snapshot data
                this.currentSnapshots = {
                    inner: null,
                    outer: null
                };

                // Callbacks
                this.onSnapshotsUpdate = null;
                this.onConnectionChange = null;
                this.onStatsUpdate = null;
                this.onControlMessage = null;

                this._initChannel();
                this._startStatsTimer();
            }

            _initChannel() {
                try {
                    this.channel = new BroadcastChannel(this.channelName);
                    this.channel.addEventListener('message', (event) => {
                        this._handleMessage(event.data);
                    });
                    
                    this._setConnected(true);
                } catch (error) {
                    console.error('Failed to initialize broadcast channel:', error);
                    this._setConnected(false);
                }
            }

            _handleMessage(data) {
                this.messageCount++;
                this.lastMessageTime = Date.now();

                if (data.type === 'controller-state') {
                    this._handleControllerState(data);
                } else if (data.type === 'control') {
                    this._handleControlMessage(data);
                }
            }

            _handleControllerState(data) {
                // Update snapshots with new data
                if (data.snapshots) {
                    let updated = false;

                    if (data.snapshots.inner) {
                        this.currentSnapshots.inner = data.snapshots.inner;
                        updated = true;
                    }

                    if (data.snapshots.outer) {
                        this.currentSnapshots.outer = data.snapshots.outer;
                        updated = true;
                    }

                    if (updated) {
                        this.updateCount++;
                        this.lastUpdate = Date.now();
                        
                        if (this.onSnapshotsUpdate) {
                            this.onSnapshotsUpdate(this.currentSnapshots);
                        }
                    }
                }
            }

            _handleControlMessage(data) {
                if (this.onControlMessage) {
                    this.onControlMessage(data.subType, data.data);
                }
            }

            _setConnected(connected) {
                if (this.connected !== connected) {
                    this.connected = connected;
                    if (this.onConnectionChange) {
                        this.onConnectionChange(connected);
                    }
                }
            }

            _startStatsTimer() {
                setInterval(() => {
                    // Calculate message rate
                    this.messageRate = Math.round(this.messageCount);
                    this.messageCount = 0;

                    // Update stats
                    if (this.onStatsUpdate) {
                        const timeSinceLastUpdate = this.lastUpdate ? 
                            Date.now() - this.lastUpdate : Infinity;

                        this.onStatsUpdate({
                            messageRate: this.messageRate,
                            updateCount: this.updateCount,
                            timeSinceLastUpdate
                        });
                    }

                    // Check if we're still receiving messages
                    const timeSinceLastMessage = Date.now() - this.lastMessageTime;
                    this._setConnected(timeSinceLastMessage < 3000); // 3 second timeout
                }, 1000);
            }

            dispose() {
                if (this.channel) {
                    this.channel.close();
                    this.channel = null;
                }
            }
        }

        // Initialize the controller display
        const display = new ControllerDisplay();

        // Get DOM elements
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const channelName = document.getElementById('channelName');
        const messageRate = document.getElementById('messageRate');
        const updateCount = document.getElementById('updateCount');
        const lastUpdate = document.getElementById('lastUpdate');
        const dataDisplay = document.getElementById('dataDisplay');

        // Set up event handlers
        display.onSnapshotsUpdate = (snapshots) => {
            updateDataDisplay(snapshots);
        };

        display.onConnectionChange = (connected) => {
            statusDot.classList.toggle('connected', connected);
            statusText.textContent = connected ? 'Connected' : 'Disconnected';
            
            if (!connected) {
                dataDisplay.innerHTML = '<div class="no-data">Connection lost</div>';
            }
        };

        display.onStatsUpdate = (stats) => {
            messageRate.textContent = stats.messageRate;
            updateCount.textContent = stats.updateCount;
            
            if (stats.timeSinceLastUpdate < 1000) {
                lastUpdate.textContent = 'Just now';
            } else if (stats.timeSinceLastUpdate < 60000) {
                lastUpdate.textContent = `${Math.floor(stats.timeSinceLastUpdate / 1000)}s ago`;
            } else {
                lastUpdate.textContent = 'Over a minute ago';
            }
        };

        display.onControlMessage = (subType, data) => {
            console.log(`Control message: ${subType}`, data);
        };

        function updateDataDisplay(snapshots) {
            if (!snapshots.inner && !snapshots.outer) {
                dataDisplay.innerHTML = '<div class="no-data">No snapshots available</div>';
                return;
            }

            let html = '<div class="snapshots-container">';
            
            // Inner snapshot
            html += '<div class="snapshot-section inner">';
            html += '<h3>ðŸ”´ Inner State</h3>';
            
            if (snapshots.inner) {
                html += `<div class="data-content">${formatState(snapshots.inner.state)}</div>`;
            } else {
                html += '<div class="no-snapshot">No inner snapshot received</div>';
            }
            
            html += '</div>';
            
            // Outer snapshot
            html += '<div class="snapshot-section outer">';
            html += '<h3>ðŸŸ¢ Outer State</h3>';
            
            if (snapshots.outer) {
                html += `<div class="data-content">${formatState(snapshots.outer.state)}</div>`;
            } else {
                html += '<div class="no-snapshot">No outer snapshot received</div>';
            }
            
            html += '</div>';
            html += '</div>';
            
            dataDisplay.innerHTML = html;
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString() + '.' + String(date.getMilliseconds()).padStart(3, '0');
        }

        function formatState(state) {
            let output = '';
            
            // Digital buttons
            if (state.digital && Object.keys(state.digital).length > 0) {
                const pressedButtons = Object.entries(state.digital).filter(([, pressed]) => pressed);
                if (pressedButtons.length > 0) {
                    output += 'DIGITAL BUTTONS:\n';
                    pressedButtons.forEach(([button, pressed]) => {
                        output += `  ${button}: PRESSED\n`;
                    });
                    output += '\n';
                }
            }
            
            // Analog inputs
            if (state.analog && Object.keys(state.analog).length > 0) {
                const activeAnalog = Object.entries(state.analog).filter(([, value]) => Math.abs(value) > 0.001);
                if (activeAnalog.length > 0) {
                    output += 'ANALOG INPUTS:\n';
                    activeAnalog.forEach(([input, value]) => {
                        output += `  ${input}: ${typeof value === 'number' ? value.toFixed(3) : value}\n`;
                    });
                    output += '\n';
                }
            }
            
            // IMU data
            if (state.imuSamples && state.imuSamples.length > 0) {
                output += `IMU SAMPLES (${state.imuSamples.length}):\n`;
                state.imuSamples.slice(0, 3).forEach((sample, i) => {
                    output += `  [${i}] accel: (${sample.accelX?.toFixed(2)}, ${sample.accelY?.toFixed(2)}, ${sample.accelZ?.toFixed(2)})\n`;
                    output += `      gyro:  (${sample.gyroX?.toFixed(2)}, ${sample.gyroY?.toFixed(2)}, ${sample.gyroZ?.toFixed(2)})\n`;
                });
                if (state.imuSamples.length > 3) {
                    output += `  ... and ${state.imuSamples.length - 3} more samples\n`;
                }
                output += '\n';
            }
            
            return output || 'No active inputs detected';
        }

        // Update channel name display
        channelName.textContent = display.channelName;

        // Make display available globally for debugging
        window.controllerDisplay = display;
    </script>
</body>
</html>